import { defineConfig, type Plugin } from 'vite';
import react from '@vitejs/plugin-react';
import { fileURLToPath } from 'node:url';
import { dirname, resolve } from 'node:path';
import { viteStaticCopy } from 'vite-plugin-static-copy';
import {
  readFileSync,
  existsSync,
  readdirSync,
  statSync,
  writeFileSync,
} from 'fs';
import { splitVendorChunkPlugin } from 'vite';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// SDK 资源文件路径
const sdkPath = resolve(__dirname, 'node_modules/@glodon-aiot/chat-app-sdk');
const sdkEsPath = resolve(sdkPath, 'es');

// 添加 SDK 资源中间件
function addSdkAssetsMiddleware(middlewares: any) {
  // 拦截 SDK 资源文件请求
  middlewares.use((req, res, next) => {
    if (!req.url) {
      next();
      return;
    }

    // 匹配 SDK 的 JS chunk 文件（如 82.js, 691.js）
    // 支持带 base 路径的请求（如 /glodon-aiot-examples/assets/82.js）
    // 也支持不带 base 路径的请求（如 /assets/82.js）
    const jsChunkMatch =
      req.url.match(/\/glodon-aiot-examples\/assets\/(\d+\.js)$/) ||
      req.url.match(/\/assets\/(\d+\.js)$/);
    if (jsChunkMatch) {
      const fileName = jsChunkMatch[1];
      const filePath = resolve(sdkEsPath, fileName);

      if (existsSync(filePath)) {
        res.setHeader('Content-Type', 'application/javascript');
        res.setHeader('Cache-Control', 'public, max-age=31536000');
        res.end(readFileSync(filePath));
        return;
      }
    }

    // 匹配哈希文件名的资源请求（如 054000aa4e72c964.png）
    const hashFileMatch = req.url.match(
      /\/([a-f0-9]{32}\.(png|svg|jpg|jpeg|gif|ttf|woff|woff2|eot))$/i,
    );
    if (hashFileMatch) {
      const fileName = hashFileMatch[1];
      const filePath = resolve(sdkEsPath, fileName);

      if (existsSync(filePath)) {
        const ext = fileName.split('.').pop()?.toLowerCase();
        const contentType: Record<string, string> = {
          png: 'image/png',
          svg: 'image/svg+xml',
          jpg: 'image/jpeg',
          jpeg: 'image/jpeg',
          gif: 'image/gif',
          ttf: 'font/ttf',
          woff: 'font/woff',
          woff2: 'font/woff2',
          eot: 'application/vnd.ms-fontobject',
        };
        res.setHeader(
          'Content-Type',
          contentType[ext || ''] || 'application/octet-stream',
        );
        res.setHeader('Cache-Control', 'public, max-age=31536000');
        res.end(readFileSync(filePath));
        return;
      }
    }

    // 匹配 node_modules 路径的资源请求
    const nodeModulesMatch = req.url.match(
      /\/node_modules\/@glodon-aiot\/chat-app-sdk\/es\/(.+)$/,
    );
    if (nodeModulesMatch) {
      const fileName = nodeModulesMatch[1];
      const filePath = resolve(sdkEsPath, fileName);

      if (existsSync(filePath)) {
        const ext = fileName.split('.').pop()?.toLowerCase();
        const contentType: Record<string, string> = {
          png: 'image/png',
          svg: 'image/svg+xml',
          jpg: 'image/jpeg',
          jpeg: 'image/jpeg',
          gif: 'image/gif',
          ttf: 'font/ttf',
          woff: 'font/woff',
          woff2: 'font/woff2',
          eot: 'application/vnd.ms-fontobject',
          js: 'application/javascript',
        };
        res.setHeader(
          'Content-Type',
          contentType[ext || ''] || 'application/octet-stream',
        );
        res.setHeader('Cache-Control', 'public, max-age=31536000');
        res.end(readFileSync(filePath));
        return;
      }
    }

    next();
  });
}

// 创建插件来处理开发环境和预览模式下的 SDK 资源文件
function sdkAssetsDevPlugin(): Plugin {
  return {
    name: 'sdk-assets-dev-plugin',
    configureServer(server) {
      // 开发环境处理
      addSdkAssetsMiddleware(server.middlewares);
    },
    configurePreviewServer(server) {
      // 预览模式处理
      addSdkAssetsMiddleware(server.middlewares);
    },
  };
}

// 创建插件来修复 SDK 中的动态导入路径（用于 GitHub Pages）
// 注意：SDK 已在 build-esm.config.ts 中添加了 publicPath: 'auto'，理论上应该自动处理路径问题
// 此插件作为后备方案，如果 SDK 修复后验证通过，可以移除此插件
function fixSdkDynamicImportsPlugin(): Plugin {
  const basePath =
    process.env.NODE_ENV === 'production' ? '/glodon-aiot-examples/' : '/';

  return {
    name: 'fix-sdk-dynamic-imports',
    writeBundle(options, bundle) {
      // 只在生产环境处理
      if (process.env.NODE_ENV !== 'production' || basePath === '/') {
        return;
      }

      // 查找 chat-sdk chunk 文件
      const chatSdkChunk = Object.keys(bundle).find(
        fileName =>
          fileName.startsWith('assets/chat-sdk-') && fileName.endsWith('.js'),
      );

      if (!chatSdkChunk) {
        return;
      }

      const filePath = resolve(options.dir || 'dist', chatSdkChunk);

      if (!existsSync(filePath)) {
        return;
      }

      // 读取文件内容
      let content = readFileSync(filePath, 'utf-8');
      let modified = false;

      // 修复 __webpack_require__.p（public path）的设置
      // 这是最关键的修复：确保 public path 指向正确的 base path
      // 匹配：__webpack_require__.p = scriptUrl (或压缩后的变量名)
      // 替换为：__webpack_require__.p = "${basePath}assets/"
      const publicPathPattern =
        /([a-zA-Z_$][a-zA-Z0-9_$]*\.p)\s*=\s*scriptUrl/g;
      if (publicPathPattern.test(content)) {
        content = content.replace(
          publicPathPattern,
          `$1 = "${basePath}assets/"`,
        );
        modified = true;
      }

      // 修复动态导入路径：将 import("./" + ...) 替换为使用 __webpack_require__.p
      // 匹配模式：import("./" + ...)
      // 替换为：import(__webpack_require__.p + ...)
      // 这样可以确保使用正确的 public path
      const importPattern = /import\("\.\/"\s*\+\s*([^)]+)\)/g;
      if (importPattern.test(content)) {
        content = content.replace(importPattern, (match, pathExpr) => {
          // 提取路径表达式，使用 __webpack_require__.p 作为前缀
          // 需要找到 __webpack_require__ 的变量名（可能是压缩后的）
          // 先尝试找到 .p 的变量名
          const pMatch = content.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\.p\s*=/);
          const webpackRequireName = pMatch ? pMatch[1] : '__webpack_require__';
          return `import(${webpackRequireName}.p + ${pathExpr})`;
        });
        modified = true;
      }

      // 如果修改了内容，写入文件
      if (modified) {
        writeFileSync(filePath, content, 'utf-8');
        console.log(`✅ Fixed dynamic import paths in ${chatSdkChunk}`);
      }
    },
  };
}

// 获取 SDK es 目录中的所有资源文件
function getSdkAssets(): Array<{ src: string; dest: string }> {
  if (!existsSync(sdkEsPath)) {
    return [];
  }

  const assets: Array<{ src: string; dest: string }> = [];
  const files = readdirSync(sdkEsPath);

  files.forEach(file => {
    const filePath = resolve(sdkEsPath, file);
    const stat = statSync(filePath);

    if (stat.isFile()) {
      const ext = file.split('.').pop()?.toLowerCase();
      // 复制资源文件和 JS chunk 文件（排除主入口文件）
      if (
        [
          'png',
          'svg',
          'jpg',
          'jpeg',
          'gif',
          'ttf',
          'woff',
          'woff2',
          'eot',
          'js', // 包含 JS chunk 文件
        ].includes(ext || '') &&
        file !== 'index.esm.js' && // 排除主入口文件
        file !== 'ui.esm.js' // 排除 UI 入口文件
      ) {
        assets.push({
          src: `node_modules/@glodon-aiot/chat-app-sdk/es/${file}`, // 相对路径
          dest: 'assets', // 复制到 dist/assets 目录
        });
      }
    }
  });

  return assets;
}

export default defineConfig({
  // GitHub Pages 部署需要设置 base 路径
  base: process.env.NODE_ENV === 'production' ? '/glodon-aiot-examples/' : '/',
  plugins: [
    react(),
    sdkAssetsDevPlugin(), // 开发环境资源处理插件
    // 自动分离 vendor chunk（node_modules 依赖）
    splitVendorChunkPlugin(),
    // 构建时复制 SDK 资源文件到 dist 目录
    viteStaticCopy({
      targets: getSdkAssets(),
    }),
    // 修复 SDK 中的动态导入路径（用于 GitHub Pages）
    fixSdkDynamicImportsPlugin(),
  ],
  resolve: {
    // 使用 node_modules 中的包，不配置任何外部源码别名
  },
  // 配置资源处理：确保所有静态资源文件被正确处理
  assetsInclude: [
    '**/*.svg',
    '**/*.png',
    '**/*.jpg',
    '**/*.jpeg',
    '**/*.gif',
    '**/*.ttf',
    '**/*.woff',
    '**/*.woff2',
    '**/*.eot',
  ],
  // 配置依赖优化：配置 esbuild 如何处理资源文件
  optimizeDeps: {
    esbuildOptions: {
      loader: {
        // 将所有静态资源文件作为文件资源处理
        '.svg': 'file',
        '.png': 'file',
        '.jpg': 'file',
        '.jpeg': 'file',
        '.gif': 'file',
        '.ttf': 'file',
        '.woff': 'file',
        '.woff2': 'file',
        '.eot': 'file',
      },
    },
  },
  server: {
    port: 3000,
    open: true,
    fs: {
      // 允许访问项目根目录的父目录，以便访问 node_modules 中的包资源
      // 这解决了访问 chat-app-sdk 构建输出目录中图片资源的 403 错误
      allow: [
        // 项目根目录
        __dirname,
        // 父目录（frontend）
        resolve(__dirname, '..'),
        // 允许访问 packages 目录（chat-app-sdk 的构建输出）
        resolve(__dirname, '..', '..', 'packages'),
        // 允许访问 node_modules（如果需要）
        resolve(__dirname, '..', '..', 'node_modules'),
      ],
    },
  },
  build: {
    outDir: 'dist',
    sourcemap: false, // 生产环境禁用 sourcemap 以减小文件大小
    // 启用代码压缩（使用 esbuild，更快）
    minify: 'esbuild',
    // 配置 chunk 大小警告阈值
    chunkSizeWarningLimit: 1000, // 1MB
    rollupOptions: {
      output: {
        // 手动配置代码分割策略
        manualChunks: id => {
          // 将 chat-app-sdk 单独打包
          if (id.includes('@glodon-aiot/chat-app-sdk')) {
            return 'chat-sdk';
          }
          // 将 React 相关依赖单独打包
          if (id.includes('react') || id.includes('react-dom')) {
            return 'react-vendor';
          }
          // 将其他 node_modules 依赖打包到 vendor
          if (id.includes('node_modules')) {
            return 'vendor';
          }
        },
        // 配置 chunk 文件命名
        chunkFileNames: 'assets/[name]-[hash].js',
        entryFileNames: 'assets/[name]-[hash].js',
        assetFileNames: assetInfo => {
          // SVG 文件保持原文件名
          if (assetInfo.name && assetInfo.name.endsWith('.svg')) {
            return 'assets/[name][extname]';
          }
          return 'assets/[name]-[hash][extname]';
        },
      },
    },
  },
});
